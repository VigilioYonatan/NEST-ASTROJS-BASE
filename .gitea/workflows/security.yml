name: Security Audit

on:
    schedule:
        # Ejecutar cada domingo a las 3am
        - cron: "0 3 * * 0"
    workflow_dispatch:
    push:
        paths:
            - "package.json"
            - "pnpm-lock.yaml"
            - "Dockerfile"

jobs:
    # =========================================================================
    # ğŸ”’ DEPENDENCY AUDIT
    # =========================================================================
    dependency-audit:
        name: ğŸ”’ Dependency Audit
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4
              with:
                  version: 10

            - uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run pnpm audit
              run: pnpm audit --audit-level=high
              continue-on-error: true

            - name: Check for outdated packages
              run: pnpm outdated || true

    # =========================================================================
    # ğŸ³ DOCKER IMAGE SCAN
    # =========================================================================
    docker-scan:
        name: ğŸ³ Docker Image Scan
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Build Docker image for scanning
              run: docker build -t scan-target:latest --target production .

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: "scan-target:latest"
                  format: "table"
                  exit-code: "0"
                  severity: "CRITICAL,HIGH,MEDIUM"
                  vuln-type: "os,library"

    # =========================================================================
    # ğŸ” SECRET SCANNING
    # =========================================================================
    secret-scan:
        name: ğŸ” Secret Scanning
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: TruffleHog Secret Scan
              uses: trufflesecurity/trufflehog@main
              with:
                  extra_args: --only-verified

    # =========================================================================
    # ğŸ“Š REPORT
    # =========================================================================
    report:
        name: ğŸ“Š Security Report
        runs-on: ubuntu-latest
        needs: [dependency-audit, docker-scan, secret-scan]
        if: always()
        steps:
            - name: Generate Summary
              run: |
                  echo "## ğŸ”’ Security Audit Report"
                  echo ""
                  echo "| Check | Status |"
                  echo "|-------|--------|"
                  echo "| ğŸ”’ Dependencies | ${{ needs.dependency-audit.result }} |"
                  echo "| ğŸ³ Docker Image | ${{ needs.docker-scan.result }} |"
                  echo "| ğŸ” Secrets | ${{ needs.secret-scan.result }} |"
