name: Security Audit

on:
    schedule:
        # Ejecutar cada domingo a las 3am
        - cron: "0 3 * * 0"
    workflow_dispatch: # Permitir ejecuciÃ³n manual
    push:
        paths:
            - "package.json"
            - "pnpm-lock.yaml"
            - "Dockerfile"

jobs:
    # =========================================================================
    # ðŸ”’ DEPENDENCY AUDIT
    # =========================================================================
    dependency-audit:
        name: ðŸ”’ Dependency Audit
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4
              with:
                  version: 10

            - uses: actions/setup-node@v6
              with:
                  node-version: "24"
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run pnpm audit
              run: pnpm audit --audit-level=high
              continue-on-error: true

            - name: Check for outdated packages
              run: pnpm outdated || true

    # =========================================================================
    # ðŸ³ DOCKER IMAGE SCAN
    # =========================================================================
    docker-scan:
        name: ðŸ³ Docker Image Scan
        runs-on: ubuntu-latest
        timeout-minutes: 20
        steps:
            - uses: actions/checkout@v4

            - name: Build Docker image for scanning
              run: docker build -t scan-target:latest --target production .

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: "scan-target:latest"
                  format: "table"
                  exit-code: "0" # No fallar, solo reportar
                  severity: "CRITICAL,HIGH,MEDIUM"
                  vuln-type: "os,library"

            - name: Run Trivy for SARIF output
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: "scan-target:latest"
                  format: "sarif"
                  output: "trivy-image-results.sarif"

            - name: Upload Trivy scan results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-image-results.sarif"

    # =========================================================================
    # ðŸ” SECRET SCANNING
    # =========================================================================
    secret-scan:
        name: ðŸ” Secret Scanning
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Escanear todo el historial

            - name: TruffleHog Secret Scan
              uses: trufflesecurity/trufflehog@main
              with:
                  extra_args: --only-verified

    # =========================================================================
    # ðŸ“Š SECURITY REPORT
    # =========================================================================
    report:
        name: ðŸ“Š Security Report
        runs-on: ubuntu-latest
        needs: [dependency-audit, docker-scan, secret-scan]
        if: always()
        steps:
            - name: Generate Summary
              run: |
                  echo "## ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| ðŸ”’ Dependencies | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| ðŸ³ Docker Image | ${{ needs.docker-scan.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| ðŸ” Secrets | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "View detailed results in the Security tab." >> $GITHUB_STEP_SUMMARY
